language: node_js
node_js:
- 8.11.2
sudo: required
cache:
  npm: true
  directories:
  - "/home/travis/.cache/Cypress"
  - "~/.npm"
install:
- npm install
- npm install -g ngrok
before_script:
- PATH=${PATH//:\.\/node_modules\/\.bin/}
- mkdir public
- curl -sO http://stedolan.github.io/jq/download/linux64/jq
- ngrok authtoken ${NGROK_AUTH_TOKEN} > /dev/null &
- ngrok http file://$(pwd)/public/ --authtoken=${NGROK_AUTH_TOKEN} > /dev/null &
- sleep 3
script:
- echo "themey@runbox.com" | npm run lint
- echo {} > credentials.json
- npm run format
- npm run build && npm run zip
- NGROK_PATH=$(curl 'http://127.0.0.1:4040/api/tunnels' | jq -r '.tunnels[0].public_url')/theme.zip
- echo "{\"theme\":{\"name\":\"Travis Curl Test - $(date +"%D %T %Z")\",\"src\":\"$NGROK_PATH\"}}"
  > body.json
- echo $(cat body.json)
- 'TEST_THEME_ID=$(curl -d @body.json -H "Accept: application/json" -H "Content-Type:
  application/json" https://${SHOPIFY_API_KEY}:${SHOPIFY_API_PASSWORD}@${SHOPIFY_URL}/admin/api/2019-07/themes.json
  | jq -r ''.theme.id'')'
- echo ${TEST_THEME_ID}
- if [ ${TEST_THEME_ID} == null ] ; then exit 1 ; fi
- while [ $(curl https://${SHOPIFY_API_KEY}:${SHOPIFY_API_PASSWORD}@${SHOPIFY_URL}/admin/api/2019-04/themes/$TEST_THEME_ID.json
  | jq -r '.theme.previewable') != 'true' ]; do echo 'Waiting for theme'; sleep 2;
  done
- cypress run --env SHOPIFY_URL=${SHOPIFY_URL},SHOPIFY_THEME_ID=$TEST_THEME_ID
- 'curl -H "Accept: application/json" -X DELETE https://${SHOPIFY_API_KEY}:${SHOPIFY_API_PASSWORD}@${SHOPIFY_URL}/admin/api/2019-07/themes/$TEST_THEME_ID.json'
addons:
  chrome: stable
  apt:
    packages:
    - libgconf-2-4
notifications:
  email: false
  slack:
    secure: RvPL7N56A4CGjVaMdqm2Mcz9pPum7qDr1sn8lvSQvZdz0gHCA4340vhwbC+Ca7BpObE6hGGadsO6FrPVs6PXYQoISm5AW/WkSDmgKKebMxRrHqLrwmtn6Y3/jxNlIWsF5vaz8R/Teq204CGRclUMONfJHw7YbmNt7Qco2OYjU2BpRZo9DZ360nSWYFHa+Ohngh2hMHGWpQVBsYl5tayiy8l8C1/TPKU+Yo5j6rvmzAOviSd0mQtPiwWO5q7exJUJpoX0GKUK4vMFrrBSNdX9Q2LoCNH8RI9br58hHv3s2jeO06rEYV3txVhUViBrNwRY6SNv4Fy0eqFkstXJIXUy7nPVV10lkt/6vd9iRaW5Vansl4TMG4gP5wNRSiMqldxgntXT0geyHGFZezi1sO/wy5JJ7QtPzrLtR/7OpzOHfcHfEI9fvB2GH8/5Vs4vBBKT0rDf30nuhEbGlcvPWMIAnUVAMu6fmp7tdQtmYZC3pBhYAdVbnsddHF0yXcCvSSLUKOUWyxOwIqcjughFmoAzKlrDCl42MX2wohHNJr9ZDhYuu1e2eaVQ8ypg+Tkh6Ss/4lBjHrHFgF+YYoN1rTokA6ChCiTw8r8VEitrHkL/GT1vQKRvHr+f+PbbAfV4FCdLbv/k6OytMnsoPhmAQJ6tAcEbVqgiQouFaKN4Oh3PpeQ=
    on_success: change
    on_pull_requests: false
    template:
    - "%{repository_slug} (%{commit}) : %{message}"
    - 'Build details: %{build_url}'
env:
  global:
  - SHOPIFY_URL: greenstore-dev.myshopify.com
  - secure: UP646CnT/wZfMK7rgjqxWqqe9FjHgxPvwUsr5WghHul4IMbU8usWpfBk4/Y3ieKasVKnPQ+Uu23GrxBM+k3lJqNIPWK0Sslmsj4ytjFTebnkT8/kCNQC7MeGoUPsY+3YE5rA8sc5hEdPrGEEbA2hjZz599GmiN6SYCqMVocjWMBu1S0wuiA6kXPRGVa5kb3T+aaMON/SlD69v5nuhVWxkdA3QJu7e4Y1ecRyJjtqwy6FcXpGq+YeK+pOrqH+GAnef4ujxS2RMknrURoNjZH0wVcKDb6fjC8e1tpKiUAxuZHE0FRAeQ+7HxoWzTvmy8K4bN+JMFXp0EjMUYm5vUEZVeDfakQ4oFI2SajxEivI+sz4sfOhYB5aD2+RP0lJkGOAgQOE0nCkNvGHoDntC/jt6ARpIBMFnEAuhSJdUL8SIMV5MJpFVFFySjTVwWiRzkNZYIxCo8VGdWXZoTPx4Uumq/S4oBC6lY/B8Yrc+C6uMGnBnkdOOGeIAkjN6IAo4BlcYkf4XWVrcoUjDUMncCLF/9MK3/Vd8W2CKqZfXUEbP63UugO1qKOZqjEUaeYEP45TMpX+hZFwlThcfLo2Go0yZQXhZIQOvKMvWi4fFvlxGrf0CSX/2URqP4T+mPZWwrmeQJyouFHdpxKsKDqwRPt0xqzS0wgmvLAAqLh6fjvuXW0=
  - secure: eX2CDCk7NXM/GnzjaFcKwr17OJuHdrxA6DUBg/SuQDeyd3DWpOoN9ktoTIFRDgqHijf3+W0IuCcQjwl2NvJypmaZ9X4u1NLZLeDqMDrxEE1Om049RnKfS8G9FhJtkdpzJ1f6oq7IvGFVJWgbX/uO40SSPMTr03KdevSTwNUxd/WPC/op0AGXwjQsKm9y18vTE8TpArlGeDd8KRIJd34N0FmihygFQlOyk13ZPZGzuQw7Dht0F5zqLlta89+8V43Qq5QMm2RTsA0fQcbd0iV9A03KkTOTthZEKKHtN88h8WztIZpMkVTT1sUmEoT0lMzWAPYWObmeUOXrYe20vnhnlGAl1ZqJ0V3CVVWyE0qv4jH+R5wbkJUpfb9qi8KKqIROhVRJTIXvCg5InaRa31USNvg+SeqE5yHMw6Ter6Nzk+sVy3lr44Kue0zkiOXS/Jcgk0gcXhlmJrz1FAKRxFnUQsII7KfaQED+mwVg49f6hi44VJLByFvR56T2HgYPhTXx48yzlg8RGCcOGlqiSwgx9XFugjJsfzs8pUJbz71ixy2/8EzJgTW7U9FAENYiVvqJRPtPfuWKuwqZWNruGbNO1PvjuteKMED5ZZGz2F5HntfC5Zte8YdUxO+0MIxrNGzBJp02XAn9+BKmoHYG665tI2Xaxl0Vs6jLtMiLBiCVp1k=
  - secure: BfSWxa29Zeww1DYT1PLX+yeNpQUc9qxItZ5vyhUa/d0QpHQiNbZ1Y9wa5zlI87S0QgxIBlMVrk2ach0ZZ5Vk9x88Py9Ry1AoiY0dJb/87Xta0jKUXrUmilZwem0Fdg0M9wGC9jhy2MmjtliIbzWRejs/XynJGs6TgDNgmt2b4wXLQk+/aWZTx2W6tFcu97RWYlr9zOcu/TYwmasMKzJCdRyhmbmXi/PPtMexWqtNk1HJ5sWVcb1vwdrIZDUzVWvv/88TI8Nbkt53s4fl+R8LrtY1/vikk3L/N+Bh+zhlQWIDX8txR2PyVqqhmNsdDZltcNXDm/W5OqMKaKeL2RMBUEmrG2/63/0UjdqoH9Bwo3DgFwD91qF14Uo843CXIHfKb3Sc3ZLHgxpyIQ5Lf31Lq9DOSPQoD4EJuKICZ/eG8t0fv2AUcpxQaU/YOmWrJxHUhvH1/BZUwDKrI8m5+cKek1ohBjxnVBHv+kL+b1IefYRONizLgiVjKA1qd/Cg6DY8tfIULjOmWbKEU7kMQ5Y1M0awDaPGXmCStLFcSsKDidOcZoDdAULScnyCDH+MgYg25zxdLrj990f3Am8PyeufziFIpopEhRPSe5ds3dbvRpQKvt1BZdQiBm/CGCMV83VacVQRYdU6PvHb4vdhovM/h2bhejj17eF0MPe+JbPItS8=
